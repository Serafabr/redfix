<!DOCTYPE html>
<html lang="en">
<head>
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
    crossorigin="anonymous"
  >
</head>
<body class="container w-50 text-justify">

<h1 class="text-center pt-5 font-weight-bold">üìÅ database</h1>

<hr/>

<p>O sistema gerenciador de banco de dados relacional (RDBMS) √© o <a href="https://www.postgresql.org/">PostgreSQL</a>.</p>

<h3>Extens√µes</h3>

<p>A extens√£o <a href="https://www.postgresql.org/docs/12/pgcrypto.html">pgcrypto</a> √© utilizada para encriptar as senhas dos usu√°rios na tabela <code>private.accounts</code>.</p>

<h3>Schemas</h3>

<p>S√£o utilizados 4 schemas ("namespaces"):</p>
<ul>
  <li><strong>public</strong> √© o default utilizado pelo PostgreSQL e onde est√£o a maioria dos objetos do banco de dados (tabelas das entidades, views, types e fun√ß√µes auxiliares).</li>
  <li><strong>private</strong> cont√©m dados que somente podem ser acessados pelos administradores (tabela com hash de senhas e 'roles' dos usu√°rios, tabela com logs/audit trails etc.).</li>
  <li><strong>api</strong> √© a interface exposta (via PostGraphile, em GraphQL) aos usu√°rios da aplica√ß√£o, contendo os objetos (views e fun√ß√µes) que traduzem as funcionalidades e requisitos definidos para o sistema.</li>
  <li><strong>web</strong> cont√©m fun√ß√µes a serem executadas pelo web server (em rotinas peri√≥dicas ou por </li>
</ul>

<p>
  As informa√ß√µes a serem armazenadas no sistema s√£o modeladas conforme abordagem sugerida no <a href="https://www.amazon.com.br/dp/1634622340/?coliid=I2OLVBO8NUF66A&colid=3M0OC5P4N6S4S&psc=1&ref_=lv_ov_lig_dp_it">DMBOK</a>.
</p>


<p>H√° ainda outras tabelas, que fazem parte do schema <code>private</code> (as explica√ß√µes sobre os schemas s√£o dadas posteriormente neste documento):</p>
<table>
  <thead>
    <tr>
      <th>Nome da tabela</th>
      <th>Conte√∫do</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>accounts</code></td>
      <td>Dados referentes a contas dos usu√°rios do sistema (e.g., hash das senhas*, pap√©is etc.).</td>
    </tr>
    <tr>
      <td><code>audit_trails</code></td>
      <td>Registros de modifica√ß√µes realizadas no banco de dados pelos usu√°rios do sistema (opera√ß√µes de <code>INSERT</code>, <code>UPDATE</code> e <code>DELETE</code>.)</td>
    </tr>
  </tbody>
</table>
<p>
  (*) Observa√ß√£o: o hash das senhas √© gerado com uma fun√ß√£o de criptografia proveniente da extens√£o <a href="https://www.postgresql.org/docs/12/pgcrypto.html"><code>pgcrypto</code></a>.
</p>


<p>
  EXPLICA√á√ÉO DA RELA√á√ÉO ENTRE OS ATIVOS
</p>


<p>
  Conven√ß√µes e estrat√©gias utilizadas:
</p>

<ol>
  <li>√çndices e chaves prim√°rias
    <p>Todas as entidades possuem um atributo de 'identidade', definido automaticamente pelo RDBMS como um n√∫mero inteiro sequencial (e.g.: coluna <code>asset_id</code> da tabela <code>assets</code>). Tais atributos s√£o as chaves prim√°rias de suas respectivas tabelas e, por isso, indexados. A indexa√ß√£o permite que uma query que busca uma entidade espec√≠fica do banco de dados retorne resultados mais rapidamente (essas queries s√£o as que ocorrem, por exemplo, quando um usu√°rio usa o sistema para visualizar uma determinada tarefa). A conven√ß√£o para os nomes dessas colunas √© utilizar a termina√ß√£o <code>_id</code></p>
    <p>A exce√ß√£o desta regra √© a tabela de pap√©is (grupos), <b>person_roles</b>, em que que a chave prim√°ria √© a pr√≥pria palavra que define o papel. Esta exce√ß√£o √© justificada pelo fato de que o comando <code>CREATE ROLE</code> n√£o aceita n√∫meros como nome do papel (o nome do papel deve ser uma palavra com caracteres alfanum√©ricos iniciada por uma letra).</p>
    <p>Algumas entidades possuem um outro atributo de identidade, correspondente a uma coluna definida com a restri√ß√£o <code>UNIQUE</code>. Os valores a serem inseridos nessas colunas devem ser c√≥digos amig√°veis, que, ao contr√°rio dos n√∫meros sequenciais, fazem sentido para a aplica√ß√£o e seus usu√°rios. Exemplo: coluna <code>asset_sf</code> na tabela <code>assets</code>. A conven√ß√£o para os nomes dessas colunas √© utilizar a termina√ß√£o <code>_sf</code> (de Senado Federal).</p>
    <p>O uso de dois identificadores d√° flexibilidade ao modelo de dados, pois, dessa maneira, o usu√°rio pode alterar livremente os c√≥digos <code>_sf</code> das entidades, com a √∫nica restri√ß√£o de que escolha um c√≥digo distinto dos c√≥digos j√° existentes. J√° a altera√ß√£o das chaves prim√°rias, opera√ß√£o proibida pelo RDBMS, torna-se desnecess√°ria para os fins da aplica√ß√£o.</p>
    <p>EXPLICA√á√ÉO DE CHAVES COM M√öLTIPLAS COLUNAS</p>
  </li>
  <li>Schemas
    
      <table>
        <thead>
          <tr>
            <th>Funcionalidade / User story</th>
            <th>Objeto do schema api</th>
            <th>Tipo da opera√ß√£o em GraphQL</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>O usu√°rio deseja visualizar todas as informa√ß√µes referentes a uma determinada tarefa</td>
            <td>View <code>api.task_data</code>, que compila, com <code>JOIN</code>s e views e fun√ß√µes auxiliares, todos os dados de uma tarefa e todas entidades a ela relacionadas (ativos, suprimentos etc.)</td>
            <td>Query</td>
          </tr>
          <tr>
            <td>O usu√°rio deseja poder cadastrar um novo contrato e seus respectivos materiais e servi√ßos</td>
            <td>Fun√ß√£o <code>api.insert_contract</code>, cujos inputs s√£o fornecidos pelo usu√°rio (via formul√°rio da UI) e executa os <code>INSERT</code>s necess√°rios nas tabelas de contratos e suprimentos</td>
            <td>Mutation</td>
          </tr>
        </tbody>
      </table>
    </p>
  </li>
  <li>Fun√ß√µes
    <ul>
      <li>Nomes das fun√ß√µes: padronizar e diferenciar em rela√ß√£o</li>
      <li>Opera√ß√µes realizadas pelas fun√ß√µes: correspondem √†s opera√ß√µes disponibilizadas na interface ao usu√°rio</li>
      <li>Business rules e checagens necess√°rias para integridade dos dados triggers</li>
    </ul>
    <p>
      Algumas das fun√ß√µes:
    </p>
    <table>
      <thead>
        <tr>
          <th>Nome da fun√ß√£o</th>
          <th>Descri√ß√£o</th>
          <th>Momento da execu√ß√£o</th>
          <th>Opera√ß√µes realizadas</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            insert_task
          </td>
          <td>
            Fun√ß√£o que cria uma tarefa.
          </td>
          <td>
            Quando o usu√°rio envia os dados inseridos no formul√°rio de cadastro de uma nova tarefa.
          </td>
          <td>
            Cria novas linhas nas tabelas que s√£o afetadas (tasks e outras a ela relacionadas, por exemplo, task_assets e task_supplies).
          </td>
        </tr>
        <tr>
          <td>
            modify_task
          </td>
          <td>
            Fun√ß√£o que altera uma tarefa.
          </td>
          <td>
            Quando o usu√°rio envia os dados inseridos no formul√°rio de edi√ß√£o de uma tarefa previamente criada.
          </td>
          <td>
            Atualiza linhas das tabelas que s√£o afetadas (tasks e outras a ela relacionadas, por exemplo, task_assets e task_supplies).
          </td>
        </tr>
        <tr>
          <td>
            check_task_supply
          </td>
          <td>
            Trigger que verifica se o suprimento pode ser vinculado a uma tarefa.
          </td>
          <td>
            Antes da inser√ß√£o (ou atualiza√ß√£o) de uma linha na tabela task_supplies.
          </td>
          <td>
            Somente permite a inser√ß√£o (ou atualiza√ß√£o) da tabela task_supplies caso as tr√™s verifica√ß√µes sejam realizadas com sucesso: (1) existe saldo suficiente para o suprimento; (2) os valores decimais da quantidade selecionada para o suprimento n√£o est√£o em desacordo com a sua especifica√ß√£o t√©cnica (h√° suprimentos que somente permitem valores inteiros); e (3) o contrato vinculado √† tarefa √© o mesmo que cont√©m o suprimento em quest√£o.
          </td>
        </tr>
        <tr>
          <td>
            log_change
          </td>
          <td>
            Trigger que registra uma modifica√ß√£o no banco de dados.
          </td>
          <td>
            Ap√≥s a inser√ß√£o (ou atualiza√ß√£o) de qualquer linha de qualquer tabela do banco de dados.
          </td>
          <td>
            Registra: (1) a id do usu√°rio que realizou a modifica√ß√£o; (2) data e hora da modifica√ß√£o; (3) opera√ß√£o realizada (INSERT, UPDATE ou DELETE); (4) nome da tabela modificada; (5) valores antigos da linha modificada, caso exista, em formato JSON; e (6) valores novos da linha modificada, caso exista, em formato JSON.
          </td>
        </tr>
      </tbody>
    </table>
    <p>
      Os testes das rotinas que permitem os usu√°rios realizarem altera√ß√µes no banco de dados 
      (por exemplo, cria√ß√£o ou atualiza√ß√£o de uma tarefa) e seus respectivos triggers de checagem s√£o encontrados em <a href="./backend/tests">/backend/tests.</a>
    </p>
  </li>
  <li>Tipos customizados
    <p>
      O tipo customizado <b>file_metadata</b> √© utilizado para aglutinar tr√™s das colunas das tabelas associativas referentes a arquivos de upload (<code>filename</code>,
      <code>uuid</code> e <code>size</code>) em um √∫nico objeto.
    </p>
    <p>
      Isto permite a simplifica√ß√£o das strings das mutations GraphQL que incluem o upload de arquivos: utiliza-se uma √∫nica vari√°vel (com o tipo <code>FileMetadatumInput</code>) em vez de tr√™s vari√°veis.
    </p>
  </li>
</ol>

<h4>Conex√£o, autentica√ß√£o, roles (pap√©is) e Row-Level Security (RLS)</h4>

<p>
  Detalhes sobre conex√£o, autentica√ß√£o e gerenciamento de sess√µes s√£o tratados no back-end (ver adiante neste documento).
</p>
<p>
  No que diz respeito ao banco de dados, o processo de autentica√ß√£o usa a fun√ß√£o (<code>api.authenticate</code>), que basicamente compara o hash da senha informada no login com o hash da senha registrado na tabela <code>private.accounts</code>. Em caso de corre√ß√£o das informa√ß√µes fornecidas, a fun√ß√£o retorna uma string com o formato <code>x-role</code>, em que <code>x</code> √© o n√∫mero do usu√°rio cadastrado no sistema (<code>person_id</code> nas tabelas <code>persons</code> e <code>private.accounts</code>) e <code>role</code> √© o respectivo papel (<code>person_role</code> na tabela <code>private.accounts</code>). O back-end √© respons√°vel por colocar a string num cookie e pass√°-lo ao cliente. A partir deste momento, as transa√ß√µes feitas pelo usu√°rio logado carregam sempre esse cookie em suas requisi√ß√µes HTTP. O PostGraphile passa as informa√ß√µes contidas no cookie para o RDBMS por meio da fun√ß√£o <a href="https://www.graphile.org/postgraphile/usage-library/#pgsettings-function"><code>pgSettings</code></a>. Durante as transa√ß√µes realizadas durante a sess√£o do usu√°rio em quest√£o, <code>x</code> e <code>role</code> s√£o acess√≠veis, respectivamente, pela fun√ß√£o <code>get_current_person_id()</code> e pela fun√ß√£o (built-in) <code>current_role</code> (ou <code>current_user</code>).
</p>
<p>
  Os pap√©is (roles) no banco de dados correspondem aos seguintes grupos de usu√°rios:
</p>
<table>
  <thead>
    <tr>
      <th>Role</th>
      <th>Grupo de usu√°rios</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>administrator</td>
      <td>Servidores lotados no SEPLAG</td>
    </tr>
    <tr>
      <td>supervisor</td>
      <td>Servidores efetivos da SINFRA</td>
    </tr>
    <tr>
      <td>inspector</td>
      <td>Terceirizados que atuam na fiscaliza√ß√£o</td>
    </tr>
    <tr>
      <td>employee</td>
      <td>Terceirizados que atuam no √¢mbito dos contratos de manuten√ß√£o</td>
    </tr>
    <tr>
      <td>visitor</td>
      <td>Pessoas externas ao sistema, sem conta cadastrada no CMMS</td>
    </tr>
  </tbody>
</table>
<p>
  A distribui√ß√£o de permiss√µes entre os grupos de usu√°rios (roles) √© dada conforme a tabela a seguir:
</p>
<table>
  <thead>
    <tr>
      <th>Permiss√£o para...</th>
      <th>administrator</th>
      <th>supervisor</th>
      <th>inspector</th>
      <th>employee</th>
      <th>visitor</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>...visualizar tarefa</td>
      <td>:heavy_check_mark:</td>
      <td>:heavy_check_mark:</td>
      <td>:heavy_check_mark:</td>
      <td>:heavy_check_mark:</td>
      <td></td>
    </tr>
    <tr>
      <td>...criar tarefa</td>
      <td>:heavy_check_mark:</td>
      <td>:heavy_check_mark:</td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
  </tbody>
</table>

</body>
</html>
